<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="https://ben-cliff.github.io/theme/css/elegant.prod.9e9d5ce754.css" media="screen">
        <link rel="stylesheet" type="text/css" href="https://ben-cliff.github.io/theme/css/custom.css" media="screen">

        <link rel="dns-prefetch" href="//fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>

        <meta name="author" content="Ben Cliff" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="bigquery, data-warehouse, data-governance, data-lifecycle-management, Data Engineering, " />

<meta property="og:title" content="Reclaiming Bigquery: A DWH Table Deprecation Strategy "/>
<meta property="og:url" content="https://ben-cliff.github.io/posts/bigquery-table-deprecation/" />
<meta property="og:description" content="Reclaiming Bigquery: A DWH Table Deprecation Strategy Introduction As data warehouses grow, so does the challenge of maintaining a clean and efficient environment. In this article, I&#39;ll share a structured approach I implemented to clean up a massive BigQuery data warehouse with hundreds of unused tables consuming over 565TB of …" />
<meta property="og:site_name" content="Today I Learned" />
<meta property="og:article:author" content="Ben Cliff" />
<meta property="og:article:published_time" content="2023-10-20T00:00:00+01:00" />
<meta name="twitter:title" content="Reclaiming Bigquery: A DWH Table Deprecation Strategy ">
<meta name="twitter:description" content="Reclaiming Bigquery: A DWH Table Deprecation Strategy Introduction As data warehouses grow, so does the challenge of maintaining a clean and efficient environment. In this article, I&#39;ll share a structured approach I implemented to clean up a massive BigQuery data warehouse with hundreds of unused tables consuming over 565TB of …">

        <title>Reclaiming Bigquery: A DWH Table Deprecation Strategy  · Today I Learned
</title>
        <link rel="shortcut icon" href="https://ben-cliff.github.io/theme/images/favicon.ico" type="image/x-icon" />
        <link rel="icon" href="https://ben-cliff.github.io/theme/images/apple-touch-icon-152x152.png" type="image/png" />
        <link rel="apple-touch-icon" href="https://ben-cliff.github.io/theme/images/apple-touch-icon.png"  type="image/png" />
        <link rel="apple-touch-icon" sizes="57x57" href="https://ben-cliff.github.io/theme/images/apple-touch-icon-57x57.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="72x72" href="https://ben-cliff.github.io/theme/images/apple-touch-icon-72x72.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="76x76" href="https://ben-cliff.github.io/theme/images/apple-touch-icon-76x76.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="114x114" href="https://ben-cliff.github.io/theme/images/apple-touch-icon-114x114.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="120x120" href="https://ben-cliff.github.io/theme/images/apple-touch-icon-120x120.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="144x144" href="https://ben-cliff.github.io/theme/images/apple-touch-icon-144x144.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="152x152" href="https://ben-cliff.github.io/theme/images/apple-touch-icon-152x152.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="152x152" href="https://ben-cliff.github.io/theme/images/apple-touch-icon-180x180.png" type="image/png" />



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="https://ben-cliff.github.io/"><span class=site-name>Today I Learned</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       https://ben-cliff.github.io
                                    >Home</a>
                                </li>
                                <li ><a href="https://ben-cliff.github.io/categories.html">Categories</a></li>
                                <li ><a href="https://ben-cliff.github.io/tags.html">Tags</a></li>
                                <li ><a href="https://ben-cliff.github.io/archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="https://ben-cliff.github.io/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="https://ben-cliff.github.io/posts/bigquery-table-deprecation/">
                Reclaiming Bigquery: A DWH Table Deprecation Strategy
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">
            
            <h1>Reclaiming Bigquery: A DWH Table Deprecation Strategy</h1>
<h2>Introduction</h2>
<p>As data warehouses grow, so does the challenge of maintaining a clean and efficient environment. In this article, I'll share a structured approach I implemented to clean up a massive BigQuery data warehouse with hundreds of unused tables consuming over 565TB of storage. This project not only resulted in significant cost savings but also improved overall data governance and warehouse performance.</p>
<h2>The Challenge</h2>
<p>Upon analyzing our data warehouse, I discovered several issues:</p>
<ul>
<li>Hundreds of tables with unknown or undocumented usage patterns</li>
<li>Over 565TB of potentially unused data storage</li>
<li>Unregulated IAM access creating security concerns</li>
<li>No process to identify and safely deprecate unused tables</li>
<li>Lack of transparency about which tables were still in active use</li>
</ul>
<p>Our organization needed a systematic approach to identify unused tables, safely mark them for deprecation, and ultimately remove them while ensuring no critical business processes were disrupted.</p>
<h2>Summary of Approach</h2>
<p>Our solution followed a structured, data-driven approach that leveraged BigQuery's metadata tables at each step:</p>
<ol>
<li>
<p><strong>Inventory Collection</strong>: Used <code>region-us.INFORMATION_SCHEMA.SCHEMATA</code> to identify all datasets, then queried <code>project-name.{dataset}.__TABLES__</code> for each dataset to collect table metadata including size and last modification dates.</p>
</li>
<li>
<p><strong>Usage Analysis</strong>: Analyzed query patterns with <code>region-us.INFORMATION_SCHEMA.JOBS_BY_ORGANIZATION</code>, examining the <code>referenced_tables</code> field to determine which tables had been accessed in the past 3 months.</p>
</li>
<li>
<p><strong>Classification System</strong>: Combined metadata from steps 1 and 2 into a custom analysis table that categorized tables based on usage patterns and business importance.</p>
</li>
<li>
<p><strong>Safe Deprecation</strong>: Applied a "_to_be_archived" suffix to potentially unused tables, monitored for impacts, then deleted confirmed unused tables after a waiting period.</p>
</li>
</ol>
<p>This approach enabled us to safely remove hundreds of unused tables while maintaining confidence that no critical business processes would be disrupted.</p>
<h2>The Solution: A Four-Phase Strategy</h2>
<h3>Phase 1: Analytics and Discovery</h3>
<p>The first step was a comprehensive analysis of our data warehouse to understand usage patterns and identify tables that could potentially be deprecated. I developed a Python script using the BigQuery API to gather metadata about all datasets and tables:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">google.cloud</span> <span class="kn">import</span> <span class="n">bigquery</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># Initialize BigQuery client</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>

<span class="c1"># Query to get all datasets</span>
<span class="n">schemata_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT schema_name FROM region-us.INFORMATION_SCHEMA.SCHEMATA;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># Query template to get table metadata for each dataset</span>
<span class="n">dataset_tables_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT</span>
<span class="s2">    table_id,</span>
<span class="s2">    dataset_id,</span>
<span class="s2">    DATE(TIMESTAMP_MILLIS(last_modified_time)) AS last_modified_date,</span>
<span class="s2">    size_bytes / 1024 / 1024 / 1024 as size_gb,</span>
<span class="s2">    size_bytes / 1024 / 1024 / 1024 /1024 as size_tb</span>
<span class="s2">FROM `project-name.</span><span class="si">{dataset}</span><span class="s2">.__TABLES__`;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># Create DataFrame to store results</span>
<span class="n">dwh_analysis_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span>
    <span class="s1">&#39;table_id&#39;</span><span class="p">,</span> <span class="s1">&#39;dataset_id&#39;</span><span class="p">,</span> <span class="s1">&#39;last_modified_date&#39;</span><span class="p">,</span> <span class="s1">&#39;size_gb&#39;</span><span class="p">,</span> <span class="s1">&#39;size_tb&#39;</span>
<span class="p">])</span>

<span class="k">def</span> <span class="nf">fetch_schemata</span><span class="p">(</span><span class="n">schemata_query</span><span class="p">,</span> <span class="n">client</span><span class="p">):</span>
    <span class="n">query_job</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">schemata_query</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">query_job</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">schemata_data_to_list</span><span class="p">(</span><span class="n">schemata_data</span><span class="p">):</span>
    <span class="n">datasets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">schemata_data</span><span class="p">:</span>
        <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">datasets</span>

<span class="k">def</span> <span class="nf">query_table_metadata</span><span class="p">(</span><span class="n">dataset_list</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">dataset_tables_query</span><span class="p">,</span> <span class="n">analysis_df</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">dataset_list</span><span class="p">:</span>
        <span class="n">tables_query</span> <span class="o">=</span> <span class="n">dataset_tables_query</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">)</span>
        <span class="n">bq_df</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">tables_query</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loading </span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">analysis_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">analysis_df</span><span class="p">,</span> <span class="n">bq_df</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">analysis_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;output.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

<span class="c1"># Main execution</span>
<span class="n">schemata_data</span> <span class="o">=</span> <span class="n">fetch_schemata</span><span class="p">(</span><span class="n">schemata_query</span><span class="p">,</span> <span class="n">client</span><span class="p">)</span>
<span class="n">dataset_list</span> <span class="o">=</span> <span class="n">schemata_data_to_list</span><span class="p">(</span><span class="n">schemata_data</span><span class="p">)</span>
<span class="n">query_table_metadata</span><span class="p">(</span><span class="n">dataset_list</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">dataset_tables_query</span><span class="p">,</span> <span class="n">dwh_analysis_df</span><span class="p">)</span>
</code></pre></div>

<p>I then uploaded this data to a dedicated analysis table in BigQuery for further processing and querying.</p>
<p>The next step was to identify which tables had recent activity and which were likely unused. For this, I created a SQL query that analyzed table access patterns using the <code>INFORMATION_SCHEMA.JOBS_BY_ORGANIZATION</code> view:</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">project</span><span class="o">-</span><span class="n">name</span><span class="p">.</span><span class="n">analysis_dataset</span><span class="p">.</span><span class="n">table_activity</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span>
<span class="w">        </span><span class="n">dataset</span><span class="p">,</span>
<span class="w">        </span><span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">job_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">jobs_in_last_3_months</span><span class="p">,</span>
<span class="w">        </span><span class="n">ARRAY_AGG</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">user_email</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">users_emails</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">SELECT</span>
<span class="w">            </span><span class="n">user_email</span><span class="p">,</span>
<span class="w">            </span><span class="n">rt</span><span class="p">.</span><span class="n">dataset_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">dataset</span><span class="p">,</span>
<span class="w">            </span><span class="n">job_id</span>
<span class="w">        </span><span class="k">FROM</span>
<span class="w">            </span><span class="o">`</span><span class="n">project</span><span class="o">-</span><span class="n">name</span><span class="p">.</span><span class="n">region</span><span class="o">-</span><span class="n">us</span><span class="p">.</span><span class="n">INFORMATION_SCHEMA</span><span class="p">.</span><span class="n">JOBS_BY_ORGANIZATION</span><span class="o">`</span><span class="p">,</span>
<span class="w">            </span><span class="k">UNNEST</span><span class="p">(</span><span class="n">referenced_tables</span><span class="p">)</span><span class="w"> </span><span class="n">rt</span>
<span class="w">        </span><span class="k">WHERE</span>
<span class="w">            </span><span class="n">rt</span><span class="p">.</span><span class="n">project_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;project-name&#39;</span>
<span class="w">            </span><span class="k">AND</span><span class="w"> </span><span class="n">creation_time</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="p">(</span><span class="n">DATE_SUB</span><span class="p">(</span><span class="k">CURRENT_DATE</span><span class="p">(),</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="k">MONTH</span><span class="p">))</span>
<span class="w">            </span><span class="k">AND</span><span class="w"> </span><span class="n">rt</span><span class="p">.</span><span class="n">dataset_id</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%_script%&#39;</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span>
<span class="p">)</span>
</code></pre></div>

<p>I combined this activity data with the table metadata to create a comprehensive view of our warehouse:</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span>
<span class="w">    </span><span class="s1">&#39;project-name&#39;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">project_id</span><span class="p">,</span>
<span class="w">    </span><span class="k">COALESCE</span><span class="p">(</span><span class="n">ta</span><span class="p">.</span><span class="n">dataset</span><span class="p">,</span><span class="w"> </span><span class="n">dwh</span><span class="p">.</span><span class="n">dataset_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">dataset_id</span><span class="p">,</span>
<span class="w">    </span><span class="n">ta</span><span class="p">.</span><span class="n">jobs_in_last_3_months</span><span class="p">,</span>
<span class="w">    </span><span class="k">CASE</span>
<span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="n">dataset_id</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;data_monitoring&#39;</span><span class="p">,</span><span class="s1">&#39;prod_analytics&#39;</span><span class="p">,</span><span class="s1">&#39;ml&#39;</span><span class="p">,</span><span class="s1">&#39;dimensions&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="k">THEN</span><span class="w"> </span><span class="k">TRUE</span>
<span class="w">        </span><span class="k">ELSE</span><span class="w"> </span><span class="k">FALSE</span>
<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">should_have_activity</span><span class="p">,</span>
<span class="w">    </span><span class="n">dataset_size_tb</span><span class="p">,</span>
<span class="w">    </span><span class="n">STRUCT</span><span class="p">(</span>
<span class="w">        </span><span class="n">dwh</span><span class="p">.</span><span class="n">tables</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">tables</span><span class="p">,</span>
<span class="w">        </span><span class="n">ta</span><span class="p">.</span><span class="n">users_emails</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">users_emails</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">dataset_struct</span>
<span class="k">FROM</span>
<span class="w">    </span><span class="n">dwh_analysis</span><span class="w"> </span><span class="n">dwh</span>
<span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span>
<span class="w">    </span><span class="n">table_activity</span><span class="w"> </span><span class="n">ta</span>
<span class="k">ON</span>
<span class="w">    </span><span class="n">ta</span><span class="p">.</span><span class="n">dataset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dwh</span><span class="p">.</span><span class="n">dataset_id</span>
</code></pre></div>

<h3>Phase 2: Access Control and Documentation</h3>
<p>The next phase involved removing unregulated IAM access to prevent unauthorized changes during the deprecation process. I also documented all known service level agreements (SLAs) and critical tables that needed to be preserved.</p>
<p>I created a classification system for tables:
- <strong>Critical tables</strong>: Known business-critical tables that should never be deprecated
- <strong>Active tables</strong>: Tables with recent query activity (within 90 days)
- <strong>Inactive tables</strong>: Tables with no recent activity and no documented purpose
- <strong>Unknown tables</strong>: Tables with no activity and no documentation</p>
<p>This classification helped establish a clear framework for the deprecation process.</p>
<h3>Phase 3: Safe Marking and Breaking Dependencies</h3>
<p>For tables classified as inactive or unknown, I implemented a creative approach to safely identify any undocumented dependencies. Instead of immediately deleting these tables, I added a suffix "_to_be_archived" to their names, which would intentionally break any queries or processes still depending on them.</p>
<p>I created a Python script that would be executed through Airflow to automate this renaming process:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">google.cloud</span> <span class="kn">import</span> <span class="n">bigquery</span>
<span class="kn">from</span> <span class="nn">google.api_core.exceptions</span> <span class="kn">import</span> <span class="n">BadRequest</span><span class="p">,</span> <span class="n">NotFound</span>

<span class="c1"># Initialize BigQuery client</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>

<span class="c1"># Query to identify tables for deprecation</span>
<span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT</span>
<span class="s2">    project_id,</span>
<span class="s2">    dataset_id,</span>
<span class="s2">    table_id</span>
<span class="s2">FROM</span>
<span class="s2">    `project-name.analysis_dataset.warehouse_activity_analysis`</span>
<span class="s2">WHERE</span>
<span class="s2">    should_have_activity IS FALSE</span>
<span class="s2">    AND table_id NOT LIKE &#39;%_to_be_archived%&#39;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="k">def</span> <span class="nf">check_table_type</span><span class="p">(</span><span class="n">table_dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if the given table ID corresponds to a TABLE type.&quot;&quot;&quot;</span>
    <span class="n">table_ref</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="n">table_dict</span><span class="p">[</span><span class="s1">&#39;dataset_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">table_dict</span><span class="p">[</span><span class="s1">&#39;table_id&#39;</span><span class="p">])</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="n">table_ref</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">table</span><span class="o">.</span><span class="n">table_type</span>

<span class="k">def</span> <span class="nf">add_archive_suffix</span><span class="p">(</span><span class="n">table_dict</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_to_be_archived&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add suffix to table name to identify it for archiving.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">check_table_type</span><span class="p">(</span><span class="n">table_dict</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;TABLE&quot;</span><span class="p">:</span>
        <span class="n">table_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">table_dict</span><span class="p">[</span><span class="s1">&#39;project_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">table_dict</span><span class="p">[</span><span class="s1">&#39;dataset_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">table_dict</span><span class="p">[</span><span class="s1">&#39;table_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Create SQL to rename the table</span>
        <span class="n">alter_table_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ALTER TABLE IF EXISTS </span><span class="si">{</span><span class="n">table_id</span><span class="si">}</span><span class="s2"> RENAME TO </span><span class="si">{</span><span class="n">table_dict</span><span class="p">[</span><span class="s1">&#39;table_id&#39;</span><span class="p">]</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">query_job</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">alter_table_query</span><span class="p">)</span>
            <span class="n">query_job</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>  <span class="c1"># Wait for the query to complete</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully renamed </span><span class="si">{</span><span class="n">table_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="n">BadRequest</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot rename table </span><span class="si">{</span><span class="n">table_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="n">NotFound</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Table </span><span class="si">{</span><span class="n">table_id</span><span class="si">}</span><span class="s2"> not found: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">table_dict</span><span class="p">[</span><span class="s1">&#39;table_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> is not a table, skipping&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

<span class="c1"># Main execution</span>
<span class="n">datasets_df</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
<span class="n">table_list</span> <span class="o">=</span> <span class="n">datasets_df</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">table_list</span><span class="p">:</span>
    <span class="n">add_archive_suffix</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
</code></pre></div>

<p>This approach provided a safety net: if renaming a table broke a critical process, we could quickly identify and restore it. After deploying this change, we monitored for issues over a two-week period.</p>
<h3>Phase 4: Cleanup and Deletion</h3>
<p>After confirming no critical processes were broken by the renamed tables, I created a final script to safely delete the marked tables:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">google.cloud</span> <span class="kn">import</span> <span class="n">bigquery</span>
<span class="kn">from</span> <span class="nn">google.api_core.exceptions</span> <span class="kn">import</span> <span class="n">NotFound</span>

<span class="c1"># Initialize BigQuery client</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>

<span class="c1"># Query to get datasets with marked tables</span>
<span class="n">fetch_datasets_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT</span>
<span class="s2">    dataset_id</span>
<span class="s2">FROM</span>
<span class="s2">    `project-name.analysis_dataset.warehouse_activity_analysis`,</span>
<span class="s2">    UNNEST(dataset_struct.tables) as dst</span>
<span class="s2">WHERE</span>
<span class="s2">    should_have_activity IS FALSE</span>
<span class="s2">    AND table_id LIKE &#39;%_to_be_archived%&#39;</span>
<span class="s2">GROUP BY 1</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="k">def</span> <span class="nf">dataset_exists</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if dataset exists.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dataset_ref</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">(</span><span class="n">dataset_ref</span><span class="p">)</span>
        <span class="n">tables</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">list_tables</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">delete_dataset</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Delete dataset and all its contents.&quot;&quot;&quot;</span>
    <span class="n">dataset_id</span> <span class="o">=</span> <span class="s1">&#39;project-name&#39;</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">dataset_id</span>
    <span class="n">client</span><span class="o">.</span><span class="n">delete_dataset</span><span class="p">(</span>
        <span class="n">dataset_id</span><span class="p">,</span>
        <span class="n">delete_contents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">not_found_ok</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted dataset </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Main execution</span>
<span class="n">dataset_ids_list</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">fetch_datasets_query</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()[</span><span class="s1">&#39;dataset_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">dataset_ids_list</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">dataset_exists</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
        <span class="c1"># For safety, require manual confirmation before deletion</span>
        <span class="n">user_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Do you want to delete the dataset </span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s1">? (Y/n): &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user_input</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">user_input</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Deleting </span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">delete_dataset</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Skipping </span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;All marked datasets have been processed&#39;</span><span class="p">)</span>
</code></pre></div>

<h2>Results and Impact</h2>
<p>This structured approach to table deprecation delivered significant benefits:</p>
<ol>
<li>
<p><strong>Storage Optimization</strong>: Successfully identified and removed 565TB of unused data, resulting in substantial cost savings.</p>
</li>
<li>
<p><strong>Improved Security</strong>: Removed unregulated IAM access, strengthening our data warehouse security posture.</p>
</li>
<li>
<p><strong>Enhanced Data Governance</strong>: Created a comprehensive inventory of all datasets and tables with their usage patterns.</p>
</li>
<li>
<p><strong>Reduced Complexity</strong>: Eliminated confusion about which tables were current and actively used.</p>
</li>
<li>
<p><strong>Better Performance</strong>: Reduced overall warehouse size improved query performance across the system.</p>
</li>
<li>
<p><strong>Transparent Process</strong>: The gradual approach with clear communication ensured no business disruption.</p>
</li>
</ol>
<h2>Key Lessons</h2>
<p>Several important lessons emerged from this project:</p>
<ol>
<li>
<p><strong>Analysis before action</strong>: A thorough understanding of table usage patterns is essential before any deprecation.</p>
</li>
<li>
<p><strong>Break connections safely</strong>: Renaming tables before deletion provides a critical safety mechanism.</p>
</li>
<li>
<p><strong>Automation is key</strong>: Scripts and workflows make the process repeatable and less error-prone.</p>
</li>
<li>
<p><strong>Communication matters</strong>: Keeping stakeholders informed throughout the process ensures alignment.</p>
</li>
<li>
<p><strong>Documentation is crucial</strong>: Maintaining clear documentation of what was removed and why helps with future governance.</p>
</li>
</ol>
<h2>Conclusion</h2>
<p>Table deprecation in BigQuery doesn't have to be risky or disruptive. By following a methodical approach—analyzing usage, communicating with stakeholders, safely marking tables, and only then performing deletion—you can confidently clean up your data warehouse, reduce costs, and improve overall system performance.</p>
<p>This framework can be adapted to any BigQuery environment, regardless of size, and provides a template for ongoing data lifecycle management rather than just a one-time cleanup.</p>


             
 
            
            
            







            <hr/>
        </div>
        <section id="article-sidebar" class="span2">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2023-10-20T00:00:00+01:00">Fri 20 October 2023</time>
            <h4>Category</h4>
            <a class="category-link" href="https://ben-cliff.github.io/categories.html#data-engineering-ref">Data Engineering</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="https://ben-cliff.github.io/tags.html#bigquery-ref">bigquery
                    <span class="superscript">5</span>
</a></li>
                <li><a href="https://ben-cliff.github.io/tags.html#data-governance-ref">data-governance
                    <span class="superscript">2</span>
</a></li>
                <li><a href="https://ben-cliff.github.io/tags.html#data-lifecycle-management-ref">data-lifecycle-management
                    <span class="superscript">2</span>
</a></li>
                <li><a href="https://ben-cliff.github.io/tags.html#data-warehouse-ref">data-warehouse
                    <span class="superscript">3</span>
</a></li>
            </ul>
<h4>Stay in Touch</h4>
<div id="sidebar-social-link">
    <a href="https://github.com/Ben-Cliff" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="GitHub" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1B1817"/><path fill="#fff" d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg>
    </a>
</div>
            





            





        </section>
</div>
</article>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>
    <div>
        CC-BY-4.0
    </div>

    <div>
        <span class="site-name">Today I Learned</span> - Daily Learning Journal
    </div>



    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script src="https://ben-cliff.github.io/theme/js/elegant.prod.9e9d5ce754.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>